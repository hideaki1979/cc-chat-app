# チャットアプリ要件定義書

## 1. プロジェクト概要

### 1.1 プロジェクト名
リアルタイムチャットアプリケーション

### 1.2 目的
ユーザー同士がリアルタイムでメッセージのやり取りができるWebアプリケーションを開発する

### 1.3 対象ユーザー
- 個人間でのコミュニケーションを求めるユーザー
- グループでのコミュニケーションを求めるユーザー
- リアルタイム性を重視するユーザー

## 2. 機能要件

### 2.1 必須機能（MVP）

#### 2.1.1 ユーザー管理機能
- **ユーザー登録**
  - メールアドレスとパスワードによる新規アカウント作成
  - 入力値のバリデーション（メール形式、パスワード強度）
  
- **認証機能**
  - メールアドレス・パスワードによるログイン
  - ログアウト機能
  - JWT認証によるセッション管理

- **プロフィール管理**
  - ユーザー名の設定・変更
  - プロフィール画像のアップロード・変更
  - 自己紹介文の設定・変更

#### 2.1.2 基本チャット機能
- **1対1チャット**
  - テキストメッセージの送受信
  - リアルタイムメッセージ表示
  - メッセージ履歴の表示

- **チャットルーム管理**
  - チャットルームの作成
  - チャットルームへの参加・退出

### 2.2 拡張機能（Phase 2）

#### 2.2.1 チャット拡張機能
- **ファイル送信機能**
  - 画像ファイルのアップロード・送信
  - その他ファイル（PDF、DOC等）の送信
  - ファイルプレビュー機能

- **既読機能**
  - メッセージの既読状態管理
  - 既読者一覧の表示

- **タイピング通知**
  - 入力中状態のリアルタイム表示
  - 「○○が入力中...」の表示

- **メッセージ操作**
  - 送信済みメッセージの編集
  - メッセージの削除（論理削除）
  - 編集履歴の管理

- **絵文字リアクション**
  - メッセージへの絵文字反応
  - リアクション一覧の表示
  - リアクション数のカウント

#### 2.2.2 グループチャット機能
- **グループ管理**
  - グループチャットルームの作成
  - メンバーの招待・追加
  - メンバーの削除・退出
  - グループ名・説明の設定

#### 2.2.3 ユーザー検索・フレンド機能
- **ユーザー検索**
  - ユーザー名・メールアドレスによる検索
  - 検索結果の表示

- **フレンド管理**
  - フレンド申請の送信
  - フレンド申請の承認・拒否
  - フレンドリストの表示
  - フレンド削除

### 2.3 将来機能（Phase 3）
- **プッシュ通知**
  - 新着メッセージの通知
  - フレンド申請の通知
  - ブラウザ通知・モバイル通知

## 3. 非機能要件

### 3.1 パフォーマンス要件

#### 3.1.1 レスポンス時間要件
- **メッセージ配信遅延**
  - P95 < 500ms / P99 < 1s
  - 平均 < 200ms
- **ページ初回ロード時間**
  - P95 < 2s / P99 < 3s
  - 平均 < 1.5s
- **API応答時間**
  - P95 < 300ms / P99 < 500ms
  - 平均 < 150ms

#### 3.1.2 スケーラビリティ要件
- **同時接続ユーザー数**: 100人以上（目標値）
- **同時アクティブユーザー数**: 50人以上
- **メッセージスループット**: 100msg/s以上

#### 3.1.3 計測・監視要件
- **計測方法**
  - RUM（Real User Monitoring）による実ユーザー体験計測
  - 合成監視による継続的パフォーマンス監視
  - APM（Application Performance Monitoring）による詳細分析
- **負荷試験条件**
  - 段階的負荷増加：10→50→100ユーザー（各5分間）
  - メッセージ送信頻度：1ユーザーあたり10msg/min
  - テスト環境：本番環境と同等スペック
  - 監視項目：CPU/メモリ使用率、DB接続数、WebSocket接続数

### 3.2 セキュリティ要件

#### 3.2.1 認証・パスワード管理
- **パスワードハッシュ化**: bcrypt (cost≥12) 使用、将来的にArgon2id移行検討
- **ペッパー適用**: 環境変数による追加ソルト (将来実装)
- **再ハッシュ条件**: cost値向上時の自動再ハッシュ (将来実装)

#### 3.2.2 JWT・トークン管理
- **アクセストークン**: 5-15分の短命化 (現在1時間→要改善)
- **リフレッシュトークン**: ローテーション + 即時失効による窃取対策
- **署名アルゴリズム**: HMAC-SHA256、32文字以上の強固な秘密鍵
- **クレーム検証**: Issuer、有効期限、改ざん検証

#### 3.2.3 トークン保管方針
- **アクセストークン**: メモリ内のみ保存 (localStorageは禁止)
- **リフレッシュトークン**: HttpOnly/Secure/SameSite=Strict Cookie (現在Lax→要強化)
- **Cookie属性**: `HttpOnly=true, Secure=true (本番), SameSite=Strict, Path=/`

#### 3.2.4 攻撃防御対策
- **XSS対策**: httpOnly Cookie、CSP Header (将来実装)
- **CSRF対策**: SameSite=Strict、CSRF トークン (将来実装)  
- **レート制限**: ログイン/サインアップ 5回/分 (将来実装)
- **IP制限**: 異常なアクセスパターンの検出・遅延 (将来実装)
- **CAPTCHA**: 連続失敗時の自動適用 (将来実装)

#### 3.2.5 アカウントセキュリティ
- **メール認証**: ユーザー登録時の必須認証 (将来実装)
- **パスワードリセット**: ワンタイムトークンによる安全なリセット (将来実装)
- **2要素認証 (2FA)**: TOTP による追加認証 (Phase 3 実装予定)
- **セッション管理**: 同時ログインセッション制限 (将来検討)

#### 3.2.6 ファイルセキュリティ
- **アップロード検証**: ファイルタイプ・サイズ・コンテンツ検査
- **ウイルススキャン**: マルウェア検出と隔離 (将来実装)
- **ストレージ分離**: アップロードファイルの CDN 分離保存

### 3.3 可用性要件
- システム稼働率：99%以上
- データベースバックアップ：日次

### 3.4 拡張性要件
- マイクロサービス化への対応
- 水平スケーリング対応
- CDN対応

## 4. 技術要件

### 4.1 技術スタック
- **モノレポ管理**: Turborepo
- **フロントエンド**: Next.js 14 + TypeScript + Tailwind CSS
- **バックエンド**: Go + Echo + WebSocket
- **データベース**: PostgreSQL
- **ORM**: Ent
- **認証**: JWT（Go Echo backend + Zustand state管理）
  - トークン保管：Access（Memory）、Refresh（HttpOnly Cookie）
  - リフレッシュローテーション：即時失効による窃取対策
  - XSS対策：HttpOnly/Secure/SameSite=Strict
  - ※将来Auth.js導入予定
- **ファイルストレージ**: AWS S3 / Cloudflare R2
- **デプロイ**: Vercel (Frontend) + Render (Backend)

### 4.2 開発環境
- **コンテナ**: Docker + Docker Compose
- **パッケージ管理**: pnpm
- **コード品質**: ESLint + Prettier + golangci-lint
- **テスト**: Jest (Frontend) + Go testing (Backend)
- **Go**: 1.24.5（ローカル/Dockerで統一）

## 5. データ要件

### 5.1 主要エンティティ
- ユーザー（Users）
- チャットルーム（Chat Rooms）
- メッセージ（Messages）
- ルームメンバー（Room Members）
- メッセージ既読（Message Reads）
- メッセージリアクション（Message Reactions）
- フレンド関係（Friendships）

### 5.2 データ保持期間
- メッセージ履歴：無期限
- ファイル：無期限
- ログ：3ヶ月

## 6. インターフェース要件

### 6.1 API設計
- RESTful API設計
- WebSocket API（リアルタイム通信）
- OpenAPI仕様書の作成

### 6.2 UI/UX要件
- レスポンシブデザイン対応
- モバイルファースト設計
- アクセシビリティ対応（WCAG 2.1 AA準拠）
- ダークモード対応

## 7. 制約事項

### 7.1 技術制約
- ブラウザサポート：Chrome、Firefox、Safari、Edge（最新2バージョン）
- モバイル対応：iOS Safari、Android Chrome

### 7.2 運用制約
- 開発期間：3ヶ月
- 開発チーム：1-2名
- 予算制約：クラウドサービス月額$50以下

## 8. リスク要件

### 8.1 技術リスク
- WebSocket接続の安定性
- ファイルアップロードのパフォーマンス
- データベースのスケーラビリティ

### 8.2 運用リスク
- セキュリティ脆弱性
- データ損失
- サービス停止

## 9. 成功指標

### 9.1 技術指標
- システム稼働率：99%以上
- メッセージ送信成功率：99.9%以上
- ページ読み込み時間：3秒以内

### 9.2 ビジネス指標
- ユーザー登録数
- 日次アクティブユーザー数
- メッセージ送信数