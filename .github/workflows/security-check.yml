name: Security Check

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  check-hash-predicates:
    name: ãƒãƒƒã‚·ãƒ¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ä¸é©åˆ‡ãªãƒ—ãƒ¬ãƒ‡ã‚£ã‚±ãƒ¼ãƒˆä½¿ç”¨ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: ripgrepã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          sudo apt-get update
          sudo apt-get install -y ripgrep

      - name: å±é™ºãªãƒ—ãƒ¬ãƒ‡ã‚£ã‚±ãƒ¼ãƒˆã®ä½¿ç”¨ãƒã‚§ãƒƒã‚¯
        run: |
          echo "ğŸ” PasswordHashãŠã‚ˆã³RefreshTokenHashã¸ã®ä¸é©åˆ‡ãªãƒ—ãƒ¬ãƒ‡ã‚£ã‚±ãƒ¼ãƒˆä½¿ç”¨ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."

          # ç¦æ­¢ã•ã‚Œã¦ã„ã‚‹ãƒ—ãƒ¬ãƒ‡ã‚£ã‚±ãƒ¼ãƒˆã®ãƒ‘ã‚¿ãƒ¼ãƒ³
          FORBIDDEN_PATTERNS=(
            'user\.PasswordHash(GT|GTE|LT|LTE|Contains|HasPrefix|HasSuffix|ContainsFold|EqualFold)\('
            'user\.RefreshTokenHash(GT|GTE|LT|LTE|Contains|HasPrefix|HasSuffix|ContainsFold|EqualFold)\('
          )

          # ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
          ERROR_FOUND=false
          for pattern in "${FORBIDDEN_PATTERNS[@]}"; do
            echo "ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯: $pattern"
            matches=$(rg --line-number --no-heading \
              -g '!apps/api/ent/**' \
              -g '!**/*_test.go' \
              -e "$pattern" || true)
            
            if [ -n "$matches" ]; then
              ERROR_FOUND=true
              echo "âŒ å±é™ºãªãƒ—ãƒ¬ãƒ‡ã‚£ã‚±ãƒ¼ãƒˆã®ä½¿ç”¨ã‚’æ¤œå‡ºã—ã¾ã—ãŸ:"
              echo "$matches"
              echo ""
            fi
          done

          if [ "$ERROR_FOUND" = true ]; then
            echo "========================================="
            echo "âŒ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯å¤±æ•—"
            echo "========================================="
            echo "ãƒãƒƒã‚·ãƒ¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆPasswordHashã€RefreshTokenHashï¼‰ã«å¯¾ã—ã¦"
            echo "é †åºæ¯”è¼ƒã‚„éƒ¨åˆ†ä¸€è‡´ç³»ã®ãƒ—ãƒ¬ãƒ‡ã‚£ã‚±ãƒ¼ãƒˆã¯ä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚"
            echo ""
            echo "ä½¿ç”¨å¯èƒ½ãªãƒ—ãƒ¬ãƒ‡ã‚£ã‚±ãƒ¼ãƒˆ:"
            echo "  - PasswordHashEQ / RefreshTokenHashEQ"
            echo "  - PasswordHashNEQ / RefreshTokenHashNEQ"
            echo "  - RefreshTokenHashIsNil / RefreshTokenHashNotNil"
            echo ""
            echo "è©³ç´°ã¯ apps/api/security_test.go ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚"
            exit 1
          else
            echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯æˆåŠŸ: å±é™ºãªãƒ—ãƒ¬ãƒ‡ã‚£ã‚±ãƒ¼ãƒˆã®ä½¿ç”¨ã¯ã‚ã‚Šã¾ã›ã‚“"
          fi
